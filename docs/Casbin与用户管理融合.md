# Casbin 与用户管理融合分析报告

本文档旨在分析 Casbin 权限引擎如何与当前系统的 RBAC 框架及其用户管理相关表结构进行深度融合，实现高效、灵活的权限控制。

## 1. 定义 RBAC 模型 (Model)

在 `configs/rbac_model.conf` 中，我们启用了标准的 RBAC（基于角色的访问控制）定义：

- **[request_definition]**: `r = sub, obj, act`
    - 定义了请求格式：`sub` (访问者 ID), `obj` (资源路径/URL), `act` (动作类型/HTTP Method)。
- **[role_definition]**: `g = _, _`
    - 核心映射：表示用户与角色之间的继承/拥有关系。
- **[policy_definition]**: `p = sub, obj, act`
    - 定义了权限规则的基础格式。这里的 `sub` 通常是角色代码 (`RoleCode`)。
- **[matchers]**: `m = g(r.sub, p.sub) && keyMatch(r.obj, p.obj) && (r.act == p.act || p.act == "*")`
    - **融合逻辑**：如果请求用户 `r.sub` 属于角色 `p.sub`，且请求资源 `r.obj` 与规则路径匹配，且动作匹配，则通过校验。

## 2. 配置 RBAC 策略 (Policy)

在本系统中，RBAC 策略通过用户管理系统的业务表与 Casbin 的规则表进行映射：

### A. 用户-角色映射 (g)
- **业务表**：`sso_user_role` (关联 `user_id` 和 `role_id`)。
- **映射关系**：当用户被分配一个角色时，Casbin 会生成一条 `g, {user_id}, {role_code}` 规则。
- **持久化**：存储在 `casbin_rule` 表中，`ptype=g`。

### B. 角色-权限映射 (p)
- **业务表**：`sso_role_menu` (关联 `role_id` 和 `menu_id`)。
- **关联路径**：`menu_id` 对应的 `sso_menu` 表中包含 `URL` 和 `Method` 字段。
- **映射关系**：系统根据角色关联的所有菜单生成权限规则，如：`p, admin, /api/user, POST`。
- **持久化**：存储在 `casbin_rule` 表中，`ptype=p`。

## 3. 集成与持久化

Casbin 通过数据库适配器与 MySQL 深度融合：

- **数据库表**：`casbin_rule` (对应模型 `SsoCasbinRule`)。
    - 该表充当了策略的唯一物理存储。
- **同步机制**：
    - **启动同步**：系统启动时，通过 `InitCasbin` 加载数据库中的所有规则。
    - **增量更新**：在用户管理界面操作“分配角色”或“配置角色菜单”时，业务逻辑会同步调用 Casbin APIs（如 `AddGroupingPolicy`, `AddPolicy`）更新该表。

## 4. 业务逻辑融合

### A. 权限校验中间件
在后端架构中，`middleware.CasbinMiddleware` 作为全局拦截器：
1. **获取上下文**：从 JWT 解析出 `user_id`。
2. **提取资源**：自动获取当前 HTTP 请求的 `RequestURI` 作为 `obj`，`Method` 作为 `act`。
3. **执行判断**：执行 `e.Enforce(user_id, obj, act)`。Casbin 会自动回溯用户的角色路径并返回布尔结果。

### B. 动态管理
系统利用 Casbin 的动态 API 实现权限的即时生效：
- **分配角色**：触发 `enforcer.AddGroupingPolicy`。
- **修改菜单资源**：当 `sso_menu` 的 API 路径变更时，同步更新相关的 `p` 规则。

## 核心优势

- **业务解耦**：代码中无需硬编码 `if (role == "admin")`，只需维护数据库规则。
- **精细化控制**：支持 RESTful 风格的接口控制，可细化到单个 API 的读写权限。
- **多租户支持**：利用 `SsoCasbinRule` 中的扩展字段，可轻松扩展为域 RBAC (`r = sub, dom, obj, act`)，实现不同租户下的隔离。

---

*Generated by Metadata Platform Documentation System, 2026.*
