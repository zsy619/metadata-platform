# 后端TODO - 阶段1：基础框架

> **阶段目标**: 搭建项目基础框架，实现数据源和模型管理  
> **预计时间**: 4周  
> **优先级**: P0（最高）

---

## 1. 项目初始化与配置 (Week 1)

### 1.1 项目结构搭建
- [x] 创建项目目录结构（Clean Architecture）
  ```
  apps/backend/
  ├── cmd/server/main.go
  ├── internal/{api,service,repository,model,middleware,utils,config}
  ├── configs/
  ├── migrations/
  └── scripts/
  ```
- [x] 初始化go.mod，配置依赖项
  - Hertz web框架
  - GORM ORM
  - Viper配置管理
  - Zap日志
  - JWT-go
  - Casbin权限
  - go-redis
  - Snowflake ID生成

### 1.2 配置管理（Viper）
- [x] 创建config.yaml配置文件模板
- [x] 定义Config结构体（Server/Database/Redis/JWT/Log/Crypto）
- [x] 实现LoadConfig函数
- [x] 支持环境变量覆盖
- [x] 支持多环境配置（dev/test/prod）
- [x] 配置验证（必填项检查）
- [x] 配置热加载机制（可选）

### 1.3 日志系统（Zap）
- [x] 集成Zap + Lumberjack
- [x] 实现InitLogger函数
- [x] 配置多级别日志（DEBUG/INFO/WARN/ERROR/FATAL）
- [x] 配置日志轮转（按大小100MB+按时间）
- [x] 支持JSON和文本格式
- [x] 添加链路追踪ID字段
- [x] 实现日志工具封装（Info/Warn/Error/Debug）

---

## 2. 数据库层 (Week 1)

### 2.1 数据库连接与迁移
- [x] 实现InitDB函数（MySQL/PostgreSQL）
- [x] 配置连接池参数
  - MaxOpenConns: 100
  - MaxIdleConns: 10
  - ConnMaxLifetime: 3600s
- [x] 实现数据库健康检查
- [x] 创建数据库迁移脚本
  - 用户管理模块表（基于用户管理模块.sql）
  - 元数据模块11张表（基于元数据模块.sql）
  - 创建索引
  - 创建初始数据

### 2.2 ID生成器
- [x] 实现Snowflake算法
- [x] InitSnowflake函数（dataCenterID, machineID）
- [x] GenerateID方法（并发安全）
- [x] 处理时钟回拨
- [x] ID生成性能测试（>100k/s）

---

## 3. Web框架 (Week 1)

### 3.1 Hertz服务器
- [x] 创建Hertz服务器实例
- [x] 配置服务器参数（Host/Port/MaxRequestBodySize）
- [x] 实现优雅关闭（信号捕获）
- [x] 配置超时设置

### 3.2 中间件
- [x] **统一响应中间件**
  - 定义Response/PageResponse结构体
  - 实现Success/Error/PageSuccess函数
  - TraceID支持
  
- [x] **全局异常处理中间件**
  - Panic捕获
  - 错误日志记录
  - 友好错误返回
  - 错误信息脱敏
  
- [x] **CORS中间件**
  - 配置允许的域名
  - 配置允许的方法和头
  - 配置是否允许凭证
  
- [x] **请求日志中间件**
  - 记录请求方法/路径/参数
  - 记录响应状态/耗时
  - 生成TraceID
  
- [ ] **限流中间件**（阶段4完善）
  - 基于IP限流
  - 基于用户限流

---

## 4. 数据源管理模块 (Week 2)

### 4.1 数据模型定义
- [x] **DataSource Model**（对应md_conn表）
  ```go
  type DataSource struct {
    ID           string
    ParentID     string  // 支持分组
    ConnName     string
    ConnKind     string  // MySQL/PostgreSQL/SQLServer/Oracle
    ConnVersion  string
    ConnHost     string
    ConnPort     int
    ConnUser     string
    ConnPassword string  // 加密存储
    ConnDatabase string
    ConnConn     string  // 自动生成连接串
    IsDeleted    int
    TenantID     string
    // 审计字段...
  }
  ```
- [x] 实现BeforeCreate钩子（密码加密+ID生成）
- [x] 实现BeforeUpdate钩子（密码变更时加密）
- [x] 密码加密工具（AES-256-GCM）
- [x] 密码解密工具

### 4.2 Repository层
- [x] 定义DataSourceRepository接口
- [x] 实现Create方法
- [x] 实现FindByID方法
- [x] 实现Update方法
- [x] 实现Delete方法（软删除）
- [x] 实现List方法（分页+搜索+按类型筛选）
- [x] 实现FindByTenantID方法
- [x] 实现Count方法

### 4.3 数据库驱动适配器
- [x] **定义MetadataExtractor接口**
  ```go
  type MetadataExtractor interface {
    TestConnection() error
    GetTables(schema string) ([]TableInfo, error)
    GetViews(schema string) ([]ViewInfo, error)
    GetTableStructure(schema, table string) (*TableStructure, error)
    GetViewDefinition(schema, view string) (string, error)
    GetColumns(schema, table string) ([]ColumnInfo, error)
    GetPrimaryKeys(schema, table string) ([]string, error)
    GetIndexes(schema, table string) ([]IndexInfo, error)
    PreviewData(schema, table string, limit int) ([]map[string]interface{}, error)
  }
  ```

- [x] **MySQLExtractor实现**
  - TestConnection（ping测试）
  - GetTables（从information_schema.TABLES查询）
  - GetViews（从information_schema.VIEWS查询）
  - GetTableStructure（表结构+字段信息）
  - GetColumns（字段详细信息：类型/长度/默认值/注释）
  - GetPrimaryKeys（主键信息）
  - GetIndexes（索引信息）
  - PreviewData（SELECT * LIMIT N）

- [ ] **PostgreSQLExtractor实现**
  - 适配PostgreSQL的系统表查询
  - 处理PostgreSQL特有类型
  - Schema处理

- [ ] **连接池管理器**
  - CreateConnection（动态创建连接）
  - GetConnection（获取或创建连接）
  - CloseConnection（关闭连接）
  - 连接池缓存（按conn_id缓存）
  - 连接健康检查

### 4.4 Service层
- [x] 实现Create方法（密码加密+连接串生成）
- [x] 实现Get方法（密码脱敏）
- [x] 实现Update方法
- [x] 实现Delete方法（检查是否被模型使用）
- [x] 实现List方法
- [x] **实现TestConnection方法**
  - 验证连接参数
  - 尝试建立连接
  - 返回测试结果+错误信息
- [x] **实现GetTables方法**（调用适配器）
- [x] **实现GetViews方法**
- [x] **实现GetTableStructure方法**
- [x] **实现PreviewTableData方法**

### 4.5 API Handler
- [x] POST /api/data-sources
  - 参数验证
  - 调用Service.Create
  - 返回创建结果
  
- [x] GET /api/data-sources
  - 解析查询参数（page/pageSize/keyword/type）
  - 调用Service.List
  - 返回分页结果
  
- [x] GET /api/data-sources/{id}
  - 参数验证
  - 调用Service.Get
  - 密码脱敏处理
  
- [x] PUT /api/data-sources/{id}
  - 参数验证
  - 调用Service.Update
  
- [x] DELETE /api/data-sources/{id}
  - 检查依赖
  - 调用Service.Delete
  
- [x] **POST /api/data-sources/{id}/test**
  - 调用Service.TestConnection
  - 返回测试结果
  
- [x] **GET /api/data-sources/{id}/tables**
  - 获取表列表
  - 支持搜索
  
- [x] **GET /api/data-sources/{id}/views**
  - 获取视图列表
  
- [x] **GET /api/data-sources/{id}/tables/{table}/structure**
  - 获取表结构
  
- [x] **GET /api/data-sources/{id}/tables/{table}/preview**
  - 数据预览（默认10条）

---

## 5. 模型管理模块基础 (Week 3)

### 5.1 数据模型定义
- [x] **Model**（md_model表）
  ```go
  type Model struct {
    ID           string
    ParentID     string
    ConnID       string
    ConnName     string
    ModelName    string
    ModelCode    string  // 唯一标识
    ModelVersion string  // 版本号
    ModelLogo    string
    ModelKind    int     // 1:SQL 2:视图/表 3:存储过程 4:关联
    IsPublic     bool    // 是否公开
    IsLocked     bool    // 是否锁定
    IsDeleted    bool
    TenantID     string
    // 审计字段...
  }
  ```

- [x] **ModelField**（md_model_field表）
  ```go
  type ModelField struct {
    ID          string
    ModelID     string
    TableSchema string
    TableID     string
    TableName   string
    ColumnID    string
    ColumnName  string
    ColumnTitle string
    Func        string  // 字段函数
    AggFunc     string  // 聚合函数：sum/count/avg/max/min
    ShowTitle   string  // 显示名称
    ShowWidth   int     // 显示宽度
    // ...
  }
  ```

- [x] **ModelTable**（md_model_table表）
- [x] **ModelJoin**（md_model_join表）
- [x] **ModelWhere**（md_model_where表）
- [x] **ModelGroup**（md_model_group表）
- [x] **ModelHaving**（md_model_having表）
- [x] **ModelOrder**（md_model_order表）
- [x] **ModelLimit**（md_model_limit表）
- [x] **ModelSQL**（md_model_sql表）

### 5.2 Repository层
- [x] Model CRUD方法
- [x] ModelField CRUD方法
- [x] 级联查询（Model + Fields）
- [x] 按ModelID查询所有配置（Fields/Tables/Joins/Wheres等）

### 5.3 模型构建Service
- [x] **BuildFromTable方法**
  - 获取数据源信息
  - 提取表结构
  - 字段类型映射
  - 生成Model配置
  - 生成ModelField配置
  - 保存到数据库
  
- [x] **BuildFromView方法**
  - 类似BuildFromTable
  - 标记为只读（IsReadOnly）
  
- [x] **字段类型映射表**
  ```go
  var DataTypeMapping = map[string]string{
    "INT":       "integer",
    "BIGINT":    "long",
    "VARCHAR":   "string",
    "TEXT":      "text",
    "DATETIME":  "datetime",
    "DATE":      "date",
    "DECIMAL":   "decimal",
    "BOOLEAN":   "boolean",
    // ...
  }
  ```

- [x] **验证规则生成器**
  - 基于NOT NULL生成必填规则
  - 基于字段长度生成长度规则
  - 基于数据类型生成格式规则

- [x] **默认值处理**
  - 提取数据库默认值
  - 处理CURRENT_TIMESTAMP等函数

### 5.4 Model Service
- [x] Create方法
- [x] Get方法（包含fields）
- [x] Update方法
- [x] Delete方法（检查依赖）
- [x] List方法（按数据源筛选）
- [x] Duplicate方法（克隆模型）

### 5.5 API Handler
- [x] POST /api/models
- [x] GET /api/models
- [x] GET /api/models/{id}
- [x] PUT /api/models/{id}
- [x] DELETE /api/models/{id}
- [x] POST /api/models/build-from-table
- [x] POST /api/models/build-from-view
- [x] GET /api/models/{id}/fields
- [x] POST /api/models/{id}/fields
- [x] PUT /api/models/{id}/fields/{fieldId}
- [x] DELETE /api/models/{id}/fields/{fieldId}

---

## 6. 认证与权限 (Week 4)

### 6.1 JWT认证
- [x] JWT工具封装
  - [x] GenerateToken（生成访问令牌+刷新令牌）
  - [x] ParseToken（解析令牌）
  - [x] RefreshToken（刷新令牌）
  - [x] ValidateToken（验证有效性）
  
- [x] Token配置
  - [x] 访问令牌过期时间（24小时）
  - [x] 刷新令牌过期时间（7天）
  - [x] 密钥配置

### 6.2 Auth Service
- [x] Login方法
  - [x] 用户名密码验证
  - [x] 生成Token
  - [x] 记录登录日志
  
- [x] Logout方法
  - [x] Token失效处理（可选：黑名单）
  
- [x] GetUserInfo方法
  - [x] 根据Token获取用户信息
  
- [x] RefreshToken方法
  - [x] 验证刷新令牌
  - [x] 生成新的访问令牌
  
- [x] ChangePassword方法

### 6.3 Auth Middleware
- [x] 实现AuthMiddleware
  - [x] 提取Token（从Header）
  - [x] 验证Token有效性
  - [x] 解析用户信息
  - [x] 注入到Context
  - [x] 处理Token过期
  
- [x] 可选路径配置（登录接口不需要认证）

### 6.4 Auth API
- [x] POST / api/auth/login
- [x] POST /api/auth/logout
- [x] GET /api/auth/profile
- [x] POST /api/auth/refresh
- [x] POST /api/auth/change-password

### 6.5 Casbin权限（基础）
- [x] 集成Casbin
- [x] 定义RBAC模型
- [x] 实现权限验证中间件
- [x] 配置基础策略
  - [x] 管理员：所有权限
  - [x] 普通用户：查看权限

---

## 阶段1验收标准

### 功能验收
- [x] 可成功登录系统
- [x] 可创建/查看/编辑/删除数据源
- [x] 数据源连接测试正常
- [x] 可获取数据库表/视图列表
- [x] 可预览表数据
- [x] 可从表构建模型
- [x] 模型CRUD正常
- [x] 所有API正常工作

### 技术验收
- [x] 日志正常输出和轮转
- [x] 数据库连接池稳定
- [x] JWT认证正常
- [x] 密码加密安全
- [x] 响应格式统一
- [x] 错误处理完善

### 性能验收
- [x] 接口响应时间 < 500ms
- [x] ID生成性能 > 100k/s
- [x] 数据库连接正常

---

---

## 7. 验证码系统 (Week 4)

### 7.1 后端实现
- [x] 集成 `base64Captcha` 依赖
- [x] 实现 `utils/captcha.go` 验证码工具
- [x] 实现 `AuthHandler.GetCaptcha` API
- [x] 更新 `AuthHandler.Login` 加入验证码校验
- [x] 注册 `/api/auth/captcha` 路由

### 7.2 前端对接
- [x] 更新 `src/api/auth.ts` 加入验证码接口
- [x] 修改 `Login.vue` 实现验证码加载与刷新
- [x] 修改 `Login.vue` 提交表单时携带验证码信息

---

**里程碑**: 基础框架搭建完成，包含数据源、模型管理、认证权限及验证码系统
