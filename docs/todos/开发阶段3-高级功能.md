# 开发阶段3：高级功能

> **项目**: 元数据管理平台
> **技术栈**:
> - 前端: Vue3 + TypeScript + Element Plus + Vite
> - 后端: Golang + Hertz + GORM + MySQL/PostgreSQL
> **最后更新**: 2026-02-13

---

## 前端开发任务

### 树形数据展示
- [ ] 树形表格组件（components/table/TreeTable.vue）
  - [ ] 树形结构渲染
  - [ ] 展开/折叠节点
  - [ ] 层级缩进显示
  - [ ] 连接线显示（可选）
  - [ ] 懒加载子节点
  - [ ] 全部展开/折叠
- [ ] 树形节点操作
  - [ ] 添加同级节点对话框
  - [ ] 添加子节点对话框
  - [ ] 编辑节点对话框
  - [ ] 删除节点确认（提示子节点处理方式）
  - [ ] 移动节点对话框或拖拽
- [ ] 树形筛选器组件（components/TreeFilter.vue）
  - [ ] 关键字搜索
  - [ ] 自动展开匹配节点
  - [ ] 高亮匹配文本
  - [ ] 只显示匹配节点及其路径
- [x] 树形数据API（api/tree.ts）
  - [x] getTreeData - 获取树形数据
  - [x] addTreeNode - 添加节点
  - [x] moveTreeNode - 移动节点
  - [x] deleteTreeNode - 删除节点

### 主子表管理
- [ ] 主子表表单（components/form/MasterDetailForm.vue）
  - [ ] 主表表单区域
  - [ ] 子表表格（嵌入式可编辑表格）
  - [ ] 添加子表行按钮
  - [ ] 删除子表行按钮
  - [ ] 编辑子表行（行内编辑或对话框）
  - [ ] 子表验证
  - [ ] 至少一条子表验证
  - [ ] 保存整体数据
- [ ] 主子表详情（components/MasterDetailView.vue）
  - [ ] 主表信息展示
  - [ ] 子表列表展示（可分页）
  - [ ] 子表排序筛选
  - [ ] 编辑按钮
  - [ ] 删除按钮
  - [ ] 添加子表数据按钮
- [x] 主子表API（api/master-detail.ts）

### 导入导出
- [ ] 导出对话框（components/ImportExport/ExportDialog.vue）
  - [ ] 格式选择（Excel/CSV/JSON）
  - [ ] 字段选择器（勾选要导出的字段）
  - [ ] 筛选条件配置（应用当前筛选或自定义）
  - [ ] 查询模板选择
  - [ ] 导出设置（编码/分隔符/样式等）
  - [ ] 进度显示（进度条）
  - [ ] 完成后自动下载
  - [ ] 错误提示
- [ ] 导入对话框（components/ImportExport/ImportDialog.vue）
  - [ ] 模板下载按钮
  - [ ] 文件上传区（拖拽或点击）
  - [ ] 文件类型验证
  - [ ] 数据预览（显示前10行）
  - [ ] 字段映射确认
  - [ ] 导入设置（是否忽略错误/更新已存在数据）
  - [ ] 导入执行
  - [ ] 进度显示
  - [ ] 成功/失败数量统计
  - [ ] 错误详情展示
  - [ ] 下载错误记录
- [ ] 文件上传组件（components/FileUpload.vue）
  - [ ] 拖拽上传
  - [ ] 点击选择
  - [ ] 文件类型验证
  - [ ] 文件大小验证
  - [ ] 上传进度
  - [ ] 上传成功/失败提示
  - [ ] 文件列表显示
  - [ ] 删除文件
- [x] 导入导出API（api/io.ts）
  - [x] exportData - 导出数据
  - [x] getImportTemplate - 获取导入模板
  - [x] importData - 导入数据

### 审计日志查看
- [x] 操作日志页面（views/logs/OperationLogs.vue）
  - [x] 日志列表
  - [x] 筛选（按用户/操作类型/模块/时间范围/状态）
  - [x] 日志详情对话框（完整请求/响应信息+JSON格式化）
  - [x] 导出日志
- [x] 数据变更日志页面（views/logs/DataChangeLogs.vue）
  - [x] 变更记录列表
  - [x] 筛选（按表名/记录ID/用户/时间范围）
  - [x] 变更对比展示（并排对比+高亮变更字段）
  - [ ] 版本回溯功能
  - [ ] 变更统计图表
- [x] 访问日志页面（views/logs/AccessLogs.vue）
  - [x] 访问记录列表
  - [x] 筛选（按用户/路径/状态码/时间范围）
  - [x] 可视化统计
    - [x] 访问量趋势图
    - [x] 响应时间统计
    - [x] 状态码分布统计
    - [x] TOP10路径
  - [ ] 异常访问高亮

---

## 后端开发任务

### 树形结构支持
- [x] TreeConfig配置管理
- [x] Tree Service
  - [x] GetTree方法（完整树+层级限制+懒加载）
  - [x] GetChildren方法（直接子节点）
  - [x] GetPath方法（根到节点路径）
  - [ ] GetDescendants方法（所有后代）
  - [x] AddNode方法（自动计算path+level）
  - [x] MoveNode方法（移动+重算路径+循环引用检测）
  - [x] DeleteNode方法（级联删除或移动子节点）
  - [x] 路径计算器（格式：/1/3/5/）
  - [x] 层级计算器
  - [x] 循环引用检测器
- [x] Tree API（部分完成）
  - [x] GET /api/tree/{model}（获取树）
  - [x] POST /api/tree/{model}/node（添加节点）
  - [ ] PUT /api/tree/{model}/node/{id}（更新节点）
  - [x] DELETE /api/tree/{model}/node/{id}（删除节点）
  - [x] POST /api/tree/{model}/node/{id}/move（移动节点）
  - [x] GET /api/tree/{model}/node/{id}/path（节点路径）
  - [x] GET /api/tree/{model}/node/{id}/children（子节点）
  - [ ] GET /api/tree/{model}/node/{id}/descendants（后代）

### 主子表支持
- [ ] ModelRelation Model（需新建表，主子表关系配置）
- [ ] MasterDetail Service
  - [x] CreateMasterDetail方法（事务：主表+子表批量）
  - [ ] GetMasterDetail方法（主表+子表列表）
  - [ ] UpdateMasterDetail方法（事务：主表+子表增删改）
  - [ ] DeleteMasterDetail方法（级联删除或设置NULL）
  - [ ] 事务管理器增强（REQUIRED/REQUIRES_NEW/NESTED）
  - [ ] 级联操作处理
- [ ] MasterDetail API
  - [x] POST /api/master-detail/{master}/{detail}/create
  - [ ] GET /api/master-detail/{master}/{detail}/{masterId}
  - [ ] PUT /api/master-detail/{master}/{detail}/{masterId}
  - [ ] DELETE /api/master-detail/{master}/{detail}/{masterId}
  - [ ] POST /api/master-detail/{master}/{detail}/{masterId}/details（添加子表）
  - [ ] PUT /api/master-detail/{master}/{detail}/{masterId}/details/{detailId}
  - [ ] DELETE /api/master-detail/{master}/{detail}/{masterId}/details/{detailId}

### 数据导入导出
- [ ] Excel Service
  - [ ] ExportToExcel方法（样式配置+大数据量流式写入）- 依赖缺失
  - [ ] GenerateTemplate方法（根据模型生成模板）- 依赖缺失
  - [ ] ImportFromExcel方法（批量插入+错误收集）- 依赖缺失
  - [ ] 数据验证（类型+长度+必填+唯一性+业务规则）
- [ ] CSV Service
  - [ ] ExportToCSV方法（分隔符配置+编码UTF-8/GBK）
  - [ ] ImportFromCSV方法（编码识别+解析+导入）
- [x] JSON Service
  - [x] ExportToJSON方法（完整结构+关联数据可选）
  - [x] ImportFromJSON方法
- [x] Import/Export API
  - [x] POST /api/data/{model}/export（导出+格式+字段+筛选）
  - [x] GET /api/data/{model}/import-template（下载模板）
  - [x] POST /api/data/{model}/import（导入+进度+错误返回）
  - [x] GET /api/data/{model}/import/{taskId}/status（导入进度）

### 审计日志
- [x] OperationLog Model（sys_operation_logs表）
- [x] DataChangeLog Model（sys_data_change_logs表）
- [x] AccessLog Model（sys_access_logs表）
- [x] Log Middleware
  - [x] OperationLog中间件（记录请求/响应+异步写入）
  - [x] DataChangeLog拦截器（记录变更前后+对比字段）
  - [x] AccessLog中间件（记录访问+响应时间）
- [x] Log Service
  - [x] QueryOperationLogs方法（按用户/模块/操作/时间筛选）
  - [x] QueryDataChangeLogs方法（按表/记录/用户/时间）
  - [x] QueryAccessLogs方法（按用户/路径/状态/时间）
  - [ ] 异常行为检测（暴力破解/异常登录/异常操作）
- [x] Log API
  - [x] GET /api/logs/operations（操作日志）
  - [x] GET /api/logs/data-changes（数据变更日志）
  - [x] GET /api/logs/access（访问日志）
  - [ ] GET /api/logs/statistics（日志统计）

---

## 验收标准

### 前端验收
- [ ] 树形数据展示和操作正常
- [ ] 主子表管理功能完整
- [ ] 导入导出功能可用
- [ ] 日志查看界面清晰

### 后端验收
- [ ] 树形数据管理正常
- [ ] 主子表操作正确
- [ ] 导入导出功能可用
- [x] 审计日志完整记录

### 集成验收
- [ ] 树形数据前后端交互正常
- [ ] 主子表数据完整保存和查询
- [ ] 导入导出功能完整可用
- [x] 日志记录和查询正常
