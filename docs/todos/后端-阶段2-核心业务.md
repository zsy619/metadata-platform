# 后端TODO - 阶段2：核心业务

> **阶段目标**: SQL生成引擎、CRUD接口自动生成、查询模板
> **预计时间**: 5周
> **优先级**: P0（核心功能）

---

## 1. SQL生成引擎 ⭐⭐⭐ (Week 1-2)

这是整个系统的核心，将元数据配置转换为可执行的SQL语句。

### 1.1 SQLBuilder架构

- [x] **创建SQLBuilder主类**

  ```go
  type SQLBuilder struct {
    db          *gorm.DB
    modelRepo   repository.ModelRepository
    tableRepo   repository.TableRepository
    fieldRepo   repository.FieldRepository
  }
  ```
- [x] **定义ModelData结构体**（聚合模型所有配置）

  ```go
  type ModelData struct {
    Model   *model.Model
    Tables  []*model.ModelTable
    Fields  []*model.ModelField
    Joins   []*model.ModelJoin
    Wheres  []*model.ModelWhere
    Groups  []*model.ModelGroup
    Havings []*model.ModelHaving
    Orders  []*model.ModelOrder
    Limit   *model.ModelLimit
    SQL     *model.ModelSQL
  }
  ```
- [x] **loadModelData方法**

  - 加载Model基本信息
  - 加载ModelFields（SELECT字段）
  - 加载ModelTables（FROM表）
  - 加载ModelJoins（JOIN关联）
  - 加载ModelWheres（WHERE条件）
  - 加载ModelGroups（GROUP BY）
  - 加载ModelHavings（HAVING条件）
  - 加载ModelOrders（ORDER BY）
  - 加载ModelLimit（分页）
  - 加载ModelSQL（原始SQL）

### 1.2 SELECT子句构建器

- [x] **buildSelectClause方法**

  - 处理空字段（SELECT *）
  - 遍历字段列表
  - 为每个字段调用buildFieldExpression
  - 添加字段别名
  - 拼接为完整SELECT子句
- [x] **buildFieldExpression方法**

  - 添加表名前缀（table.column）
  - 应用字段函数（UPPER/LOWER/DATE_FORMAT等）
  - 应用聚合函数（SUM/COUNT/AVG/MAX/MIN）
  - 处理函数参数
- [ ] **支持的字段函数**

  - 字符串函数：UPPER/LOWER/TRIM/CONCAT/SUBSTRING
  - 日期函数：DATE_FORMAT/DATE_ADD/DATE_SUB/NOW
  - 数学函数：ROUND/CEIL/FLOOR/ABS
  - 其他：COALESCE/NULLIF/CASE WHEN

### 1.3 FROM和JOIN子句构建器

- [x] **buildFromClause方法**

  - 查找主表（is_main=true）
  - 支持schema.table格式
  - 处理表别名
- [x] **buildJoinClause方法**

  - 调用buildJoinTree构建树形结构
  - 调用generateJoinSQL递归生成
- [x] **buildJoinTree方法**

  - 根据parent_id构建JOIN树
  - 支持嵌套JOIN
  - 建立父子关系
- [x] **generateJoinSQL方法**（递归）

  - 生成JOIN类型（LEFT/RIGHT/INNER/FULL OUTER）
  - 生成表名
  - 调用buildJoinConditions生成ON条件
  - 递归处理子JOIN
- [x] **buildJoinConditions方法**

  - 处理左括号
  - 处理左侧字段+函数
  - 处理运算符
  - 处理右侧字段/值+函数
  - 处理右括号
  - 处理AND/OR逻辑

### 1.4 WHERE子句构建器（重点）

- [x] **buildWhereClause方法**

  - 遍历WHERE条件列表
  - 处理逻辑运算符（AND/OR）
  - 处理括号（支持复杂嵌套）
  - 调用buildSingleCondition
  - 拼接完整WHERE子句
- [x] **buildSingleCondition方法**

  - 构建左侧表达式（字段+函数）
  - 根据运算符选择处理方式
  - 构建右侧表达式（字段/值+函数）
  - 返回完整条件和参数
- [ ] **支持的运算符处理**

  - **=、!=、>、<、>=、<=**：简单比较
  - **LIKE**：模糊匹配（自动添加%）
  - **IN**：范围查询（支持多值）
  - **BETWEEN**：区间查询（两个值）
  - **IS NULL / IS NOT NULL**：空值判断
- [x] **参数化查询**（防SQL注入）

  - 使用?占位符
  - 值通过args数组传递
  - 不直接拼接用户输入
- [ ] **动态参数替换**

  - 支持params参数传入
  - 优先使用动态参数
  - 回退到配置的固定值

### 1.5 GROUP BY和HAVING子句

- [x] **buildGroupByClause方法**

  - 遍历分组字段
  - 添加表名前缀
  - 应用字段函数
  - 拼接GROUP BY子句
- [x] **buildHavingClause方法**

  - 类似WHERE逻辑
  - 支持聚合函数条件
  - 参数化查询

### 1.6 ORDER BY和LIMIT子句

- [x] **buildOrderByClause方法**

  - 遍历排序字段
  - 添加表名前缀+函数
  - 添加ASC/DESC
  - 支持多字段排序
- [x] **buildLimitClause方法**

  - 计算OFFSET = (page-1)*pageSize
  - 生成LIMIT子句
  - 支持动态分页参数

### 1.7 SQL组装与验证

- [x] **buildFromMetadata方法**

  - 按顺序调用各子句构建器
  - 组装完整SQL
  - 返回SQL字符串和参数数组
- [x] **buildFromSQL方法**

  - 处理model_kind=1（原始SQL）
  - 直接返回ModelSQL.content
  - 参数替换（可选）
- [x] **SQL语法验证**

  - 检查关键字冲突
  - 检查括号匹配
  - 检查字段存在性
- [x] **SQL注入检测**

  - 检测危险字符
  - 验证参数类型
  - 记录可疑SQL

---

## 2. SQL执行器 (Week 2)

### 2.1 SQLExecutor实现

- [x] **Execute方法**

  - 调用SQLBuilder.BuildSQL生成SQL
  - 获取数据源连接
  - 执行查询
  - 解析结果
  - 返回数据
- [x] **ExecuteCount方法**

  - 生成COUNT SQL
  - 执行查询
  - 返回总数
- [x] **parseRows方法**

  - 获取列名
  - 遍历结果集
  - 解析为map切片
  - 处理NULL值
  - 类型转换

### 2.2 连接管理

- [x] **GetConnection方法**

  - 根据conn_id获取连接
  - 从缓存获取或新建
  - 连接健康检查
- [ ] **日志和监控**

  - 记录生成的SQL
  - 记录执行时间
  - 慢查询告警（>1s）
  - 错误日志

---

## 3. 字段增强配置 (Week 3)

### 3.1 新建表

- [x] **创建md_model_field_enhancements表**
  ```sql
  CREATE TABLE md_model_field_enhancements (
    id varchar(64) PRIMARY KEY,
    field_id varchar(64),
    display_name varchar(128),      -- 显示名称
    display_order int,               -- 显示顺序
    display_width int,               -- 显示宽度
    is_searchable tinyint(1),        -- 可搜索
    is_sortable tinyint(1),          -- 可排序
    is_filterable tinyint(1),        -- 可筛选
    placeholder varchar(256),        -- 占位符
    help_text varchar(512),          -- 帮助文本
    component_type varchar(64),      -- 组件类型
    component_config text,           -- 组件配置JSON
    -- 审计字段
  );
  ```

### 3.2 Model/Service/API

- [ ] FieldEnhancement Model定义
- [x] FieldEnhancement Repository（CRUD）
- [x] FieldEnhancement Service
  - UpdateEnhancements（单个更新）
  - BatchUpdateEnhancements（批量更新）
  - GetEnhancements（查询）
- [x] FieldEnhancement API
  - [x] GET /api/models/{id}/fields/enhancements
  - [x] PUT /api/models/{id}/fields/enhancements
  - [x] POST /api/models/{id}/fields/batch-enhancements

---

## 4. CRUD接口自动生成 (Week 3-4)

### 4.1 接口配置Model

- [ ] API Model（基于现有表结构）
- [ ] APIParam Model

### 4.2 接口生成器

- [ ] **BatchGenerate方法**
  - 获取模型信息
  - 生成Create接口配置
  - 生成Read接口配置
  - 生成Update接口配置
  - 生成Delete接口配置
  - 生成List接口配置
  - 检测路径冲突
  - 批量保存配置

### 4.3 动态路由注册器

- [ ] **DynamicRouter类**

  ```go
  type DynamicRouter struct {
    engine *route.Engine
    crudService *service.CRUDService
  }
  ```
- [ ] **RegisterAPI方法**

  - 根据API配置注册路由
  - 绑定对应的handler
  - 运行时动态注册
- [x] **Handler实现**

  - handleCreate（调用CRUD.Create）
  - handleGet（调用CRUD.Get）
  - handleUpdate（调用CRUD.Update）
  - handleDelete（调用CRUD.Delete）
  - handleList（调用CRUD.List）

### 4.4 通用CRUD Service

- [ ] **Create方法**

  - 获取模型配置
  - 数据验证
  - 应用默认值
  - 生成ID
  - 插入数据
  - 返回结果
- [ ] **Get方法**

  - 根据ID查询
  - 返回单条数据
- [ ] **Update方法**

  - 验证数据
  - 更新记录
- [ ] **Delete方法**

  - 软删除（is_deleted=1）
- [x] **List方法**

  - 应用查询模板（可选）
  - 应用筛选条件
  - 排序
  - 分页
  - 返回列表+总数
- [ ] **批量操作**

  - BatchCreate
  - BatchUpdate
  - BatchDelete

### 4.5 数据验证器

- [x] 自定义验证规则

### 4.6 API管理接口

- [ ] GET /api/apis（列表）
- [ ] POST /api/apis/batch-generate（批量生成）
- [ ] PUT /api/apis/{id}（更新）
- [ ] DELETE /api/apis/{id}（删除）
- [ ] POST /api/apis/{id}/enable（启用/禁用）
- [ ] POST /api/apis/{id}/test（测试）

---

## 5. 查询模板管理 (Week 4)

### 5.1 Model定义

- [ ] QueryTemplate Model
- [ ] QueryCondition Model

### 5.2 Service实现

- [x] Create/Get/Update/Delete
- [x] SetDefault（设置默认模板）
- [x] ApplyTemplate（应用模板到查询）
- [ ] Duplicate（复制模板）

### 5.3 API实现

- [x] GET /api/models/{id}/query-templates（列表）
- [x] POST /api/models/{id}/query-templates（创建）
- [x] GET /api/query-templates/{id}（详情）
- [x] PUT /api/query-templates/{id}（更新）
- [x] DELETE /api/query-templates/{id}（删除）
- [x] POST /api/query-templates/{id}/set-default（设为默认）
- [ ] POST /api/query-templates/{id}/duplicate（复制）
- [ ] GET /api/query-templates/{id}/preview（预览SQL+结果）

---

## 6. 通用数据查询API (Week 5)

### 6.1 数据CRUD接口
- [x] POST /api/data/{model}/query（通用查询）
- [x] GET /api/data/{model}（列表+模板）
- [x] GET /api/data/{model}/{id}（详情）
- [x] POST /api/data/{model}（创建）
- [x] PUT /api/data/{model}/{id}（更新）
- [x] DELETE /api/data/{model}/{id}（删除）

### 6.2 批量操作接口
- [x] POST /api/data/{model}/batch-create
- [x] PUT /api/data/{model}/batch-update
- [x] DELETE /api/data/{model}/batch-delete

### 6.3 统计查询接口

- [x] GET /api/data/{model}/statistics（统计）
- [x] POST /api/data/{model}/aggregate（聚合）

---

## 阶段2验收标准

### 功能验收

- [ ] SQL生成引擎可生成简单查询SQL
- [ ] SQL生成引擎可生成复杂JOIN SQL
- [ ] SQL生成引擎可生成聚合查询SQL
- [ ] SQL执行正常，返回正确结果
- [ ] 可批量生成CRUD接口配置
- [ ] 动态路由正常注册和工作
- [ ] 通用CRUD接口可正常操作数据
- [ ] 查询模板可创建和应用
- [ ] 所有API正常工作

### 技术验收

- [ ] SQL生成性能<10ms
- [ ] SQL执行性能合理
- [ ] 参数化查询防止SQL注入
- [ ] 错误处理完善
- [ ] 日志记录完整

### 测试验收

- [x] SQL生成引擎单元测试覆盖率>80%
- [x] CRUD Service单元测试
- [x] API集成测试

---

**里程碑**: SQL生成引擎完成，CRUD接口可自动生成和使用
